# Spring Boot、RESTサンプルアプリ

> Spring Boot で作成した、簡易RESTシステムです
> - ログイン認証
> - CRUD
> - パスワード暗号化

| パッケージ名 | バージョン |
| ------------ | ---------- |
| OpenJDK      | 17.0.3     |
| Gradle       | 7.4.2      |
| Spring Boot  | 2.7.0      |

## 現状の説明

> 昨年末位に、クライアント側はVue.js、サーバー側はSpring Boot RESTful APIの構成で  
> 簡易作業管理SPAアプリを作成していたところでしたが、特にVue.jsは  
> まだまだ公開できる状況ではありませんので、先にSpring Boot側を公開します。  
> Spring Boot側も、まだ作成途中ではありますが、面倒な認証機能と、簡易的なCRUD操作は  
> 完成していますので、 RESTful APIのベースとしては流用可能だと思います。  
>   
> テーブルは、userとplace(場所情報名)しかありません。  
> データベースは、簡易的に利用できるよう、H2 Databaseを使用しています。永続化はしていません。  
> 起動時にデータベースを自動再生成し、動作確認用の、２アカウントを登録しています。  
> JPAで、DBをPostgreSQL等に切り替え、永続化設定すれば、実用システムとして完成できると思います。
  
## 事前準備

- JavaとGragleをインストールしておくこと

## プロジェクト作成方法

[spring initializr](https://start.spring.io/)

- Gragle
- Java
- Spring Boot 2.7.0
- Metadata
  - Group: com.mysv986
  - Artifact: spring_boot_rest
  - Name: spring_boot_rest
  - Description: Spring Boot、REST、Sample
  - Package name: com.mysv986.spring_boot_rest
- Jar
- Java 17
- Dependencies
  - Spring Security
  - Spring Data JPA
  - Spring Web
  - Spring Configuration Processor
  - H2 Database
  - Lombok

## 実行方法

```
$ ./gradlew bootRun
```

http://localhost:8000/

## 動作確認方法

```
ログイン（admin）
$ curl -i -c cookie.txt -X POST "http://localhost:8000/app/login" -d "account=admin" -d "password=admin"
HTTP/1.1 200 
Vary: Origin
Vary: Access-Control-Request-Method
Vary: Access-Control-Request-Headers
Set-Cookie: XSRF-TOKEN=2440df59-3b8a-41c6-8c21-0f7b49a943c2; Path=/app; HttpOnly
Set-Cookie: JSESSIONID=6E0CF9FDF000DE742637FCD60E3D7C76; Path=/app; HttpOnly
Access-Control-Expose-Headers: X-My-CSRF-Header
X-My-CSRF-Header: 2440df59-3b8a-41c6-8c21-0f7b49a943c2
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
Cache-Control: no-cache, no-store, max-age=0, must-revalidate
Pragma: no-cache
Expires: 0
X-Frame-Options: DENY
Content-Length: 0
Date: Sun, 29 May 2022 07:37:37 GMT

クッキーを確認
$ cat cookie.txt 
# Netscape HTTP Cookie File
# https://curl.se/docs/http-cookies.html
# This file was generated by libcurl! Edit at your own risk.

#HttpOnly_localhost     FALSE   /app    FALSE   0       JSESSIONID      6E0CF9FDF000DE742637FCD60E3D7C76
#HttpOnly_localhost     FALSE   /app    FALSE   0       XSRF-TOKEN      2440df59-3b8a-41c6-8c21-0f7b49a943c2

user 一覧取得（クッキーは必要だが、XSRF-TOKENは不要）
$ curl -i -b cookie.txt -c cookie.txt "http://localhost:8000/app/user/list"
HTTP/1.1 200 
Vary: Origin
Vary: Access-Control-Request-Method
Vary: Access-Control-Request-Headers
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
Cache-Control: no-cache, no-store, max-age=0, must-revalidate
Pragma: no-cache
Expires: 0
X-Frame-Options: DENY
Content-Type: application/json
Transfer-Encoding: chunked
Date: Sun, 29 May 2022 07:43:33 GMT

[ {
  "id" : 1,
  "account" : "admin",
  "password" : null,
  "email" : "admin@example.com",
  "admin" : true
}, {
  "id" : 2,
  "account" : "test",
  "password" : null,
  "email" : "test@example.com",
  "admin" : false
} 

user 1 取得
curl -i -b cookie.txt -c cookie.txt "http://localhost:8000/app/user/1"

place 一覧取得
$curl -i -b cookie.txt -c cookie.txt "http://localhost:8000/app/place/list"

```

## ビルド

```
$ ./gradlew build
$ java -jar build/libs/spring_boot_rest-0.0.1-SNAPSHOT.jar
```

http://localhost:8000/

## 参考文献

- [Spring Security with Spring Boot 2.0で簡単なRest APIを実装する](https://qiita.com/rubytomato@github/items/6c6318c948398fa62275)

## サーバー構築（CentOS Stream release 8）

> 動作環境
> - [WebARENA Indigo](https://web.arena.ne.jp/indigo/)
>   - 事前に以下で、Webサーバー環境を作っておく
>     - `01_Indigo.md`
>     - `02_Apache.md`
>     - `80_OpenJDK.md`
>       - OpneJDK
>       - Gradle

> https://github.com/develop986/centos_server

### 動作環境構築

```
# git clone https://github.com/develop986/spring_boot_rest
# git pull
# cd spring_boot_rest
# ./gradlew build
# java -jar build/libs/spring_boot_rest-0.0.1-SNAPSHOT.jar

動作環境でビルドする場合は、gradlew build で、
必要なバージョンのGradleが自動でダウンロードされるらしく、
事前のGradleインストールは不要らしい
```

## サービス作成

```
  580  vi /etc/systemd/system/springbootrest.service
  581  cat /etc/systemd/system/springbootrest.service
  582  systemctl enable springbootrest.service
  583  systemctl start springbootrest.service
  584  systemctl stop springbootrest.service
  586  systemctl restart springbootrest.service
  586  systemctl status springbootrest.service

[root@centos ~]# cat /etc/systemd/system/springbootrest.service
[Unit]
Description=springbootrest server
After=syslog.target network.target

[Service]
Type=simple
ExecStart=/usr/bin/java -jar /root/spring_boot_rest/build/libs/spring_boot_rest-0.0.1-SNAPSHOT.jar
WorkingDirectory=/root/spring_boot_rest
KillMode=process
Restart=always
User=root
Group=root

[Install]
WantedBy=multi-user.target
```

### VirtualHost 設定

```
# vi /etc/httpd/conf/httpd.conf

以下のファイルを作成する

<VirtualHost *:80>
    ServerAdmin room@mysv986.com
    DocumentRoot /var/www/html/
    ServerName springbootrest.mysv986.com
    ServerAlias springbootrest.mysv986.com
RewriteEngine on
RewriteCond %{SERVER_NAME} =springbootrest.mysv986.com
RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,NE,R=permanent]
</VirtualHost>
```

```
# systemctl restart httpd
# certbot --apache -d springbootrest.mysv986.com
# systemctl restart httpd
```

```
# vi /etc/httpd/conf/httpd-le-ssl.conf

Include以下に、SSLProxy設定を追記する。

<VirtualHost *:443>
    ServerAdmin room@mysv986.com
    DocumentRoot /var/www/html/
    ServerName springbootrest.mysv986.com
    ServerAlias springbootrest.mysv986.com

SSLCertificateFile /etc/letsencrypt/live/springbootrest.mysv986.com/fullchain.pem
SSLCertificateKeyFile /etc/letsencrypt/live/springbootrest.mysv986.com/privkey.pem
Include /etc/letsencrypt/options-ssl-apache.conf

    SSLEngine on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    SSLProxyCheckPeerExpire off
    SSLProxyEngine on
    ProxyRequests off
    ProxyPass / http://springbootrest.mysv986.com:8000/
    ProxyPassReverse / http://springbootrest.mysv986.com:8000/

</VirtualHost>
```

```
# systemctl restart httpd
```

https://springbootrest.mysv986.com

## サーバー動作確認方法

```
ログイン
$ curl -i -c cookie.txt -X POST "https://springbootrest.mysv986.com/app/login" -d "account=admin" -d "password=admin"

ユーザー一覧取得
$ curl -i -b cookie.txt -c cookie.txt "https://springbootrest.mysv986.com/app/user/list"

```